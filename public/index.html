<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>留言板</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <!-- LIFF v1只能用到2021年4月 https://developers.line.biz/en/docs/liff/versioning-policy/ -->
    <!-- LIFF v2從2019年10月啟用 https://developers.line.biz/en/docs/liff/developing-liff-apps/#developing-a-liff-app -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
        <!-- Firebase JavaScript SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> <!-- 新增实时数据库模块的引用 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // 定義 auth 變數在全局範圍
        const firebaseConfig = {
        apiKey: "AIzaSyBHpI4FEtn_BwHIflsS5HFcgCVcADZxFHo",
                    authDomain: "test-7e963.firebaseapp.com",
                    databaseURL: "https://test-7e963-default-rtdb.firebaseio.com",
                    projectId: "test-7e963",
                    storageBucket: "test-7e963.appspot.com",
                    messagingSenderId: "555361679149",
                    appId: "1:555361679149:web:a0865f6148e4beedf705a4",
                    measurementId: "G-03YPJLJHMJ"
    };
        
      // Firebase初始化
        (function() {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase 初始化成功');
            // 這裡可以進行其他初始化後的操作
        })();
        

        // Firebase Storage引用
        const storage = firebase.storage();
        const db = firebase.database(); // 初始化 Firebase 实时数据库引用
    
         document.addEventListener("DOMContentLoaded", function(){
		 
		 const showAllMessagesButton = document.getElementById("showAllMessagesButton");
		showAllMessagesButton.addEventListener("click", async function() {
			await displayMessages();
		});
		 
		 
	


			
			// 留言板消息的查询快照
			let querySnapshot;

			// 添加实时更新监听器
			firebase.firestore().collection('project').doc('messages').collection('messages')
				.onSnapshot((snapshot) => {
					querySnapshot = snapshot;
					displayMessages();
				});

		 
		 
			document.getElementById('messages').addEventListener('click', function(event) {
				// 确保点击的是按钮
				if (event.target.tagName === 'BUTTON') {
					// 获取点击按钮所在的留言元素
					const messageElement = event.target.closest('.message');
					if (messageElement) {
						const messageId = messageElement.getAttribute('data-id');
						if (event.target.textContent === '修改') {
						
							const userId = 'U0a49e765a241d21992c6d0a8f5fa4a34'; // 假设用户ID为固定值
							const titleElement = messageElement.querySelector('h4');
							const titleText = titleElement.textContent;
							const colonIndex = titleText.indexOf(':');
							if (colonIndex !== -1) {
								const replyNumber = titleText.substring(colonIndex + 1).trim();
								editMessage(userId, replyNumber);
								
							};

						} else if (event.target.textContent === '刪除') {
						//const userId = document.getElementById("getProfileUserId").innerHTML;
							const userId = 'U0a49e765a241d21992c6d0a8f5fa4a34'; // 假设用户ID为固定值
							const titleElement = messageElement.querySelector('h4');
							const titleText = titleElement.textContent;
							const colonIndex = titleText.indexOf(':');
							if (colonIndex !== -1) {
								const replyNumber = titleText.substring(colonIndex + 1).trim();
								deleteMessage(userId, replyNumber);
							}
							
						}
						
					}
					
					 // 获取点击按钮所在的评论元素
					const commentElement = event.target.closest('.comment');
					if (commentElement) {
						const commentId = commentElement.getAttribute('data-comment-id');
						if (event.target.textContent === '修改評論') {
							editComment(commentId);
						} else if (event.target.textContent === '删除評論') {
							deleteComment(commentId);
						}
					}
				}
			});

		
		
		
            // 參考 https://developers.line.biz/en/reference/liff/#initialize-liff-app
            liff
                .init({
                    // 這裡要改成自己的LIFF URL的後半段 https://liff.line.me/##########-XXXXXXXX
                    liffId: '2003991300-029M8WXw'    
                })
                .then(() => {
                
                    // 參考 https://developers.line.biz/en/reference/liff/#get-line-version
                    document.getElementById("getLineVersion").innerHTML = liff.getLineVersion();

                    // 參考 https://developers.line.biz/en/reference/liff/#is-in-client
                    document.getElementById("isInClient").innerHTML = liff.isInClient();

                    // 參考 https://developers.line.biz/en/reference/liff/#get-context
                    document.getElementById("getContextViewType").innerHTML = liff.getContext().viewType;
                    document.getElementById("getContextType").innerHTML = liff.getContext().type;
                    document.getElementById("getContextUtouId").innerHTML = liff.getContext().utouId;
                    document.getElementById("getContextGroupId").innerHTML = liff.getContext().groupId;
                    document.getElementById("getContextRoomId").innerHTML = liff.getContext().roomId;

                    // 參考 https://developers.line.biz/en/reference/liff/#is-logged-in
                    document.getElementById("isLoggedIn").innerHTML = liff.isLoggedIn();
                    
                    // 參考 https://developers.line.biz/en/reference/liff/#get-profile
                    liff.getProfile()
                    .then(profile => {
                        document.getElementById("getProfileDisplayName").innerHTML = profile.displayName;
                        document.getElementById("getProfileUserId").innerHTML = profile.userId;
                        document.getElementById("getProfilePictureUrl").innerHTML = profile.pictureUrl;
                    })
                    .catch((err) => {
                      console.log('error', err);
                    }); 

                    // 參考 https://developers.line.biz/en/reference/liff/#get-os
                    document.getElementById("getOS").innerHTML = liff.getOS();

                    // 參考 https://developers.line.biz/en/reference/liff/#get-language
                    document.getElementById("getLanguage").innerHTML = liff.getLanguage();

                })
                .catch((err) => {
                    alert(JSON.stringify(err));
                });
				
				

							 
				
			window.onload = function() {
				const messageForm = document.getElementById('messageForm');
				const tagsInput = document.getElementById('tagsInput'); // 获取标签输入框的 DOM 元素
				const tagsList = document.getElementById('tagsList'); // 标签选择列表
				const imageInput = document.getElementById('imageInput'); // 获取上传的图片文件输入框
				const uploadedImagesContainer = document.getElementById('uploadedImagesContainer'); // 存放上传图片的容器

				let inputCount = 0; // 记录用户的输入次数

				// 初始化时检查输入框的值是否以 # 开头
				if (tagsInput.value.trim().startsWith('#')) {
					tagsList.style.display = 'block'; // 显示标签选择列表
				} else {
					tagsList.style.display = 'none'; // 隐藏标签选择列表
				}

				// 监听输入框的输入事件
				tagsInput.addEventListener('input', function(event) {
					const inputValue = event.target.value;

					// 如果输入框中包含一个或多个 #
					if (inputValue.includes('#')) {
						// 显示标签选择列表
						tagsList.style.display = 'block';
					} else {
						// 隐藏标签选择列表
						tagsList.style.display = 'none';
					}
				});

				// 监听标签选择列表项的点击事件
				tagsList.addEventListener('click', function(event) {
					const selectedTag = event.target.textContent; // 获取用户选择的标签

					// 添加选择的标签到标签输入框的值中
					if (tagsInput.value) {
						tagsInput.value +=  selectedTag;
					} else {
						// 如果输入框中还没有标签存在，则直接添加新标签
						tagsInput.value = selectedTag;
					}

					tagsList.style.display = 'none'; // 隐藏标签选择列表
					inputCount++; // 增加用户的输入次数
				});

				// 监听图片文件输入框的变化事件
				imageInput.addEventListener('change', function(event) {
					const files = event.target.files; // 获取用户选择的文件列表

					// 清空之前的图片显示
					uploadedImagesContainer.innerHTML = '';

					// 遍历用户选择的每个文件
					for (let i = 0; i < files.length; i++) {
						const file = files[i]; // 获取当前文件

						// 检查是否选择了文件
						if (file) {
							// 创建一个FileReader对象
							const reader = new FileReader();

							// 当文件加载完成后执行以下代码
							reader.onload = function(e) {
								// 创建一个新的img元素
								const img = document.createElement('img');
								// 设置img元素的src属性为文件的URL，从而显示在网页上
								img.src = e.target.result;
								img.classList.add('fixed-size-image');
								// 将img元素添加到存放上传图片的容器中
								uploadedImagesContainer.appendChild(img);
							};

							// 读取文件
							reader.readAsDataURL(file);
						}
					}
					
					 const imageFiles = event.target.files; // 获取用户选择的文件列表

					
				});

				// 监听表单的提交事件
				messageForm.addEventListener('submit', function(event) {
					event.preventDefault();

					// 获取表单中的值
					const title = document.getElementById('titleInput').value;
					const content = document.getElementById('contentInput').value;
					//const userId = document.getElementById("getProfileUserId").innerHTML;
					const userId = 'U0a49e765a241d21992c6d0a8f5fa4a34'; // 假设用户ID为固定值
					let tags = tagsInput.value.match(/#[^\s#]*/g); // 使用正则表达式匹配标签
					const imageFiles = [];
					for (let i = 0; i < imageInput.files.length; i++) {
						imageFiles.push(imageInput.files[i]);
					}

					// 将以上内容存储到 Cloud Firestore，具体实现请根据你的项目进行编写
					saveMessageToFirestore(title, content,  userId, tags, imageFiles);
					console.log(imageFiles);

					// 提交后清空表单
					messageForm.reset();
					// 清空之前的图片显示
					uploadedImagesContainer.innerHTML = '';
					
				});
			};

	
					
		async function saveMessageToFirestore(title, content, userId, tags, imageFiles) {
			const db = firebase.firestore();

			// 构建文档名称，使用 userId_title 形式
			const docName = userId + '_' + title;

			try {
				// 检查是否存在相同标题的消息
				const querySnapshot = await db.collection('project').doc('messages').collection('messages')
					.where('title', '==', title)
					.get();

				if (!querySnapshot.empty) {
					// 如果存在相同标题的消息，显示警告消息并且不执行保存操作
					alert('標題名稱重複！');
					// 清空之前的图片显示
					uploadedImagesContainer.innerHTML = '';
					return;
				}

				// 创建文档引用
				const newMessageRef = db.collection('project').doc('messages').collection('messages').doc(docName);

				// 构建消息对象
				const messageData = {
					title: title,
					content: content,
					time: firebase.firestore.FieldValue.serverTimestamp(),
					userId: userId,
					tags: tags,
					// 其他字段...
				};

				// 将消息数据保存到 Cloud Firestore
				await newMessageRef.set(messageData);
				console.log('消息已成功保存到 Cloud Firestore！');

				// 上传图片到 Firebase Storage，并将图片下载URL保存到消息对象中
				for (let i = 0; i < imageFiles.length; i++) {
					const imageUrl = await uploadImageToStorage(imageFiles[i], newMessageRef);
					// 将图片的 URL 设置为消息对象的字段，每张图片使用不同的字段名
					await newMessageRef.update({ ['imageUrl_' + i]: imageUrl });
				}

				alert('留言已成功上傳！');
			} catch (error) {
				console.error('保存消息到 Cloud Firestore 时出错：', error);
				alert('保存消息到 Cloud Firestore 时出错：' + error.message);
			}
		}



						
		async function uploadImageToStorage(imageFile, messageRef) {
			try {
				const storage = firebase.storage();
				const storageRef = storage.ref();
				const imageRef = storageRef.child('images/' + messageRef.id);

				// 将图像文件上传到 Firebase Storage
				const snapshot = await imageRef.put(imageFile);
				console.log('圖片已成功上傳到 Firebase Storage！');
				alert('圖片已成功上傳！');

				// 获取上传图像文件的下载URL
				const url = await imageRef.getDownloadURL();
				return url;
			} catch (error) {
				console.error('將圖片上傳到 Firebase Storage 時出错：', error);
				alert('將圖片上傳到 Firebase Storage 時出错：' + error.message);
			}
		}
		
		
		


// 外部定义 generateRandomId() 函数
function generateRandomId() {
    // 创建一个随机整数作为ID
    const randomId = Math.floor(Math.random() * 1000000);
    // 将时间戳与随机ID连接起来
    return randomId;
}



let selectedMessageId = null; // 全局变量用于存储当前选定的留言ID
let globalMessageInfo = {}; // 在这里定义全局变量
const db = firebase.firestore();
const userId = 'U0a49e765a241d21992c6d0a8f5fa4a34'; // 假设用户ID为固定值

<!-- async function displayMessages() { -->
    <!-- try { -->
        <!-- console.log('Fetching messages from the database...'); -->
        <!-- // 获取留言板消息的查询快照 -->
        <!-- const querySnapshot = await db.collection('project').doc('messages').collection('messages').get(); -->
        <!-- console.log('Messages fetched successfully:', querySnapshot.docs.length, 'messages found.'); -->

        <!-- // 清空之前显示的留言 -->
        <!-- const messagesContainer = document.getElementById('messages'); -->
        <!-- messagesContainer.innerHTML = ''; -->

        <!-- // 遍历每条留言并渲染到 HTML 页面上 -->
		<!-- querySnapshot.forEach((doc, index) => { -->
			<!-- console.log('Rendering message:', doc.id); -->
			<!-- const message = doc.data(); // 获取留言数据 -->

			<!-- // 将时间转换为格式化的字符串 -->
			<!-- const formattedTime = message.time.toDate().toLocaleString(); // 将时间转换为本地时间格式的字符串 -->

			<!-- // 检查并处理标签是否为数组 -->
			<!-- const tags = Array.isArray(message.tags) ? message.tags.join(', ') : ''; // 如果 message.tags 不是数组，则将其置为空字符串 -->

			<!-- // 构建留言的 HTML 元素 -->
			<!-- let messageElement = '<div class="message">'; -->
			<!-- messageElement += '<p><h4><strong>標題:</strong> ' + message.title + '</h4></p>'; -->
			<!-- messageElement += '<p><strong>名稱:</strong> ' + message.userId + '</p>'; -->
			<!-- messageElement += '<p><strong>時間:</strong> ' + formattedTime + '</p>'; -->
			<!-- messageElement += '<p><strong>內文:</strong> ' + message.content + '</p>'; -->
			<!-- messageElement += '<p><strong>標籤:</strong> ' + tags + '</p>'; -->
			<!-- messageElement += '<p><strong>圖片:</strong></p>'; -->
			<!-- messageElement += '<ul>'; -->
			<!-- Object.keys(message).filter(key => key.startsWith('imageUrl_')).forEach(key => { -->
				<!-- messageElement += '<li><img src="' + message[key] + '" style="width: 200px; height: 200px;"></li>'; -->
			<!-- }); -->
			<!-- messageElement += '</ul>'; -->

			<!-- // 添加修改和删除按钮（如果用户ID匹配） -->
			<!-- if (message.userId === userId) { -->
				<!-- // 构建修改按钮 -->
				<!-- const editButton = document.createElement('button'); -->
				<!-- editButton.textContent = '修改'; // 设置按钮的文本内容 -->

				<!-- messageElement += editButton.outerHTML; -->

				<!-- // 构建删除按钮 -->
				<!-- const deleteButton = document.createElement('button'); -->
				<!-- deleteButton.textContent = '刪除'; // 设置按钮的文本内容 -->

				<!-- messageElement += deleteButton.outerHTML; -->
			<!-- } -->

			<!-- // 创建评论容器和评论表单 -->
			<!-- const commentContainerId = 'comments-' + doc.id; -->
			<!-- messageElement += '<div id="' + commentContainerId + '"></div>'; // 创建评论容器 -->
			<!-- const commentForm = '<form class="commentForm" data-message-id="' + doc.id + '">' + -->
									<!-- '<input type="text" name="commentContent" placeholder="请输入评论内容">' + -->
									<!-- '<button type="submit" class="submitCommentButton">提交评论</button>' + -->
								<!-- '</form>'; -->

			<!-- // 将留言元素和评论表单添加到页面上 -->
			<!-- messagesContainer.innerHTML += messageElement + commentForm; -->
			<!-- // 添加分隔线 -->
			<!-- messagesContainer.insertAdjacentHTML('beforeend', '<hr>'); -->

			<!-- // 将留言的相关信息存储到全局变量中 -->
			<!-- globalMessageInfo[doc.id] = {userId: message.userId, title: message.title}; -->
			
			<!-- // 添加事件监听器以便在留言表单提交时重新加载留言和评论 -->
			<!-- const commentForms = document.querySelectorAll('.commentForm'); -->
			<!-- commentForms.forEach(commentForm => { -->
				<!-- commentForm.addEventListener('submit', function(event) { -->
					<!-- event.preventDefault(); -->
					<!-- const commentContent = commentForm.querySelector('input[name="commentContent"]').value; -->
					<!-- const messageId = commentForm.getAttribute('data-message-id'); -->
					<!-- const messageInfo = globalMessageInfo[messageId]; -->

					<!-- // 检查留言信息是否存在 -->
					<!-- if (messageInfo) { -->
						<!-- // 调用处理评论提交的函数，并传递留言的相关信息和评论内容 -->
						<!-- handleCommentSubmit(event, messageInfo, userId, db, commentContent); -->
					<!-- } else { -->
						<!-- console.error('Failed to find message info.'); -->
					<!-- } -->
				<!-- }); -->
			<!-- }); -->


			<!-- // 渲染每个留言的评论 -->
			<!-- displayComments(doc.id, commentContainerId); // 根据留言的ID显示评论，传入评论容器的ID -->
		<!-- }); -->

    <!-- } catch (error) { -->
        <!-- console.error('Error fetching messages:', error); -->
    <!-- } -->
<!-- } -->

<!-- async function displayMessages() { -->
    <!-- try { -->
        <!-- console.log('Fetching messages from the database...'); -->
        <!-- // 获取留言板消息的查询快照 -->
        <!-- const querySnapshot = await db.collection('project').doc('messages').collection('messages').get(); -->
        <!-- console.log('Messages fetched successfully:', querySnapshot.docs.length, 'messages found.'); -->

        <!-- // 清空之前显示的留言 -->
        <!-- const messagesContainer = document.getElementById('messages'); -->
        <!-- messagesContainer.innerHTML = ''; -->

        <!-- // 遍历每条留言并渲染到 HTML 页面上 -->
        <!-- querySnapshot.forEach((doc, index) => { -->
            <!-- console.log('Rendering message:', doc.id); -->
            <!-- const message = doc.data(); // 获取留言数据 -->

            <!-- // 将时间转换为格式化的字符串 -->
            <!-- const formattedTime = message.time.toDate().toLocaleString(); // 将时间转换为本地时间格式的字符串 -->

            <!-- // 构建留言的 HTML 元素 -->
            <!-- let messageElement = '<div class="message">'; -->
            <!-- <!-- messageElement += '<p><h4><strong>標題:</strong> ' + message.title + '</h4></p>'; --> -->
			
			<!-- // 构建标题和按钮容器 -->
			<!-- const titleAndButtonsContainer = document.createElement('div'); -->
			<!-- titleAndButtonsContainer.style.display = 'flex'; // 设置容器为弹性布局 -->
			<!-- titleAndButtonsContainer.style.alignItems = 'center'; // 垂直居中对齐 -->

			<!-- // 添加标题 -->
			<!-- const titleElement = document.createElement('h4'); -->
			<!-- titleElement.innerHTML = '<strong>標題:</strong> ' + message.title; -->
			<!-- titleElement.style.width = '2000px'; // 设置标题的宽度 -->
			<!-- titleAndButtonsContainer.appendChild(titleElement); -->
			
            <!-- // 添加修改和删除按钮（如果用户ID匹配） -->
            <!-- if (message.userId === userId) { -->
                <!-- <!-- // 构建修改按钮 --> -->
                <!-- <!-- const editButton = document.createElement('button'); --> -->
                <!-- <!-- editButton.textContent = '修改'; // 设置按钮的文本内容 --> -->
				<!-- <!-- editButton.style.backgroundColor = 'green'; // 设置修改按钮的背景颜色 --> -->

                <!-- <!-- messageElement += editButton.outerHTML; --> -->

                <!-- <!-- // 构建删除按钮 --> -->
                <!-- <!-- const deleteButton = document.createElement('button'); --> -->
                <!-- <!-- deleteButton.textContent = '刪除'; // 设置按钮的文本内容 --> -->
				<!-- <!-- deleteButton.style.backgroundColor = 'red'; // 设置删除按钮的背景颜色 --> -->

                <!-- <!-- messageElement += deleteButton.outerHTML; --> -->
				
				<!-- // 添加修改按钮 -->
				<!-- const editButton = document.createElement('button'); -->
				<!-- //editButton.textContent = '修改'; // 设置按钮的文本内容 -->
				
				<!-- const icon = document.createElement('i'); -->
				<!-- icon.className = 'fas fa-edit'; // Font Awesome 图标类 -->
				<!-- icon.style.marginRight = '8px'; // 设置图标右边距 -->
				
				<!-- const textNode = document.createTextNode('修改'); -->
				<!-- editButton.appendChild(icon); -->
				<!-- editButton.appendChild(textNode); -->
				
				<!-- editButton.style.backgroundColor = '#007bff'; // 设置修改按钮的背景颜色 -->
				<!-- editButton.style.marginLeft = 'auto'; // 将修改按钮靠右对齐 -->
				<!-- titleAndButtonsContainer.appendChild(editButton); -->

				<!-- // 添加删除按钮 -->
				<!-- const deleteButton = document.createElement('button'); -->
				
				<!-- const icon2 = document.createElement('i'); -->
				<!-- icon2.className = 'fas fa-trash'; // Font Awesome 图标类 -->
				<!-- icon2.style.marginRight = '8px'; // 设置图标右边距 -->
				
				<!-- const textNode2 = document.createTextNode('刪除'); -->
				<!-- deleteButton.appendChild(icon2); -->
				<!-- deleteButton.appendChild(textNode2); -->
				
				<!-- //deleteButton.textContent = '刪除'; // 设置按钮的文本内容 -->
				<!-- deleteButton.style.backgroundColor = 'red'; // 设置删除按钮的背景颜色 -->
				<!-- deleteButton.style.marginLeft = '10px'; // 设置删除按钮与修改按钮之间的间距 -->
				<!-- titleAndButtonsContainer.appendChild(deleteButton); -->
            <!-- } -->
			
			<!-- // 将标题和按钮容器添加到消息元素中 -->
			<!-- messageElement += '<p>'; -->
			<!-- messageElement += titleAndButtonsContainer.outerHTML; -->
			<!-- messageElement += '</p>'; -->
            <!-- messageElement += '<p><i class="fas fa-user"></i><strong></strong> ' + message.userId + '</p>'; -->
			<!-- messageElement += '<p><i class="fas fa-clock"></i><strong></strong> ' + formattedTime + '</p>'; -->
            
			<!-- messageElement += '<p><i class="fas fa-align-left"></i><strong></strong> <span class="large-text">' + message.content + '</span></p>'; -->

            <!-- messageElement += '<p><i class="fas fa-tags"></i><strong></strong>' + getTagsAsLinks(message.tags) + '</p>'; -->
            <!-- messageElement += '<p><i class="fas fa-image"></i><strong></strong></p>'; -->
            <!-- messageElement += '<ul>'; -->
            <!-- Object.keys(message).filter(key => key.startsWith('imageUrl_')).forEach(key => { -->
                <!-- messageElement += '<li><img src="' + message[key] + '" style="width: 200px; height: 200px;"></li>'; -->
            <!-- }); -->
            <!-- messageElement += '</ul>'; -->


            <!-- // 创建评论容器和评论表单 -->
            <!-- const commentContainerId = 'comments-' + doc.id; -->
            <!-- messageElement += '<div id="' + commentContainerId + '"></div>'; // 创建评论容器 -->
            <!-- const commentForm = '<form class="commentForm" data-message-id="' + doc.id + '">' + -->
                        <!-- '<div style="display: flex; align-items: center;">' + -->
                            <!-- '<input type="text" name="commentContent" placeholder="請输入評論内容" style="width: 1600px; margin-right: 10px; border: 2px solid #ccc; border-radius: 5px; padding: 5px;">' + -->
                            <!-- '<button type="submit" class="submitCommentButton">提交評論</button>' + -->
                        <!-- '</div>' + -->
                    <!-- '</form>'; -->



			

            <!-- // 将留言元素和评论表单添加到页面上 -->
            <!-- messagesContainer.innerHTML += messageElement + commentForm; -->
            <!-- // 添加分隔线 -->
            <!-- messagesContainer.insertAdjacentHTML('beforeend', '<hr>'); -->

            <!-- // 将留言的相关信息存储到全局变量中 -->
            <!-- globalMessageInfo[doc.id] = {userId: message.userId, title: message.title}; -->

            <!-- // 添加事件监听器以便在留言表单提交时重新加载留言和评论 -->
            <!-- const commentForms = document.querySelectorAll('.commentForm'); -->
            <!-- commentForms.forEach(commentForm => { -->
                <!-- commentForm.addEventListener('submit', function(event) { -->
                    <!-- event.preventDefault(); -->
                    <!-- const commentContent = commentForm.querySelector('input[name="commentContent"]').value; -->
                    <!-- const messageId = commentForm.getAttribute('data-message-id'); -->
                    <!-- const messageInfo = globalMessageInfo[messageId]; -->

                    <!-- // 检查留言信息是否存在 -->
                    <!-- if (messageInfo) { -->
                        <!-- // 调用处理评论提交的函数，并传递留言的相关信息和评论内容 -->
                        <!-- handleCommentSubmit(event, messageInfo, userId, db, commentContent); -->
                    <!-- } else { -->
                        <!-- console.error('Failed to find message info.'); -->
                    <!-- } -->
                <!-- }); -->
            <!-- }); -->
			
			<!-- displayComments(doc.id, commentContainerId); // 根据留言的ID显示评论，传入评论容器的ID -->
        <!-- }); -->

        <!-- // 添加标签点击事件监听器 -->
        <!-- const tagsLinks = document.querySelectorAll('.tag-link'); -->
        <!-- tagsLinks.forEach(tagLink => { -->
            <!-- tagLink.addEventListener('click', function(event) { -->
                <!-- event.preventDefault(); -->
                <!-- const tag = tagLink.textContent.trim(); -->
                <!-- filterMessagesByTag(tag); -->
            <!-- }); -->
        <!-- }); -->

    <!-- } catch (error) { -->
        <!-- console.error('Error fetching messages:', error); -->
    <!-- } -->
<!-- } -->

async function displayMessages() {
    try {
        console.log('Fetching messages from the database...');
        const querySnapshot = await db.collection('project').doc('messages').collection('messages').get();
        console.log('Messages fetched successfully:', querySnapshot.docs.length, 'messages found.');

        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';

        // 遍历每条留言并渲染到 HTML 页面上
        for (const doc of querySnapshot.docs) {
            console.log('Rendering message:', doc.id);
            const message = doc.data();

            const formattedTime = message.time.toDate().toLocaleString();

            // 构建标题和按钮容器
            const titleAndButtonsContainer = document.createElement('div');
            titleAndButtonsContainer.style.display = 'flex';
            titleAndButtonsContainer.style.alignItems = 'center';

            const titleElement = document.createElement('h4');
            titleElement.innerHTML = '<strong>標題:</strong> ' + message.title;
            titleElement.style.width = '2000px';
            titleAndButtonsContainer.appendChild(titleElement);

            // 如果 userId 存在，则获取用户信息
            let userInfoHtml = '<p><i class="fas fa-user"></i><strong></strong> ' + message.userId + '</p>';
            try {
                const userProfile = await fetchUserProfile(message.userId); // 获取用户信息
                if (userProfile) {
                    const { pictureUrl, displayName } = userProfile;
                    userInfoHtml = '<p><img src="' + pictureUrl + '" alt="User Avatar" class="avatar" /> <strong>' + displayName + '</strong>(' + message.userId+ ')</p>' ;

                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
            }

            if (message.userId === userId) {
                const editButton = document.createElement('button');
                const icon = document.createElement('i');
                icon.className = 'fas fa-edit';
                icon.style.marginRight = '8px';
                const textNode = document.createTextNode('修改');
                editButton.appendChild(icon);
                editButton.appendChild(textNode);
                editButton.style.backgroundColor = '#007bff';
                editButton.style.marginLeft = 'auto';
                titleAndButtonsContainer.appendChild(editButton);

                const deleteButton = document.createElement('button');
                const icon2 = document.createElement('i');
                icon2.className = 'fas fa-trash';
                icon2.style.marginRight = '8px';
                const textNode2 = document.createTextNode('刪除');
                deleteButton.appendChild(icon2);
                deleteButton.appendChild(textNode2);
                deleteButton.style.backgroundColor = 'red';
                deleteButton.style.marginLeft = '10px';
                titleAndButtonsContainer.appendChild(deleteButton);
            }

            let messageElement = '<div class="message">';
            messageElement += '<p>${titleAndButtonsContainer.outerHTML}</p>';
            messageElement += userInfoHtml; // 插入用户信息
            messageElement += '<p><i class="fas fa-clock"></i><strong></strong> ' + formattedTime + '</p>';
            messageElement += '<p><i class="fas fa-align-left"></i><strong></strong> <span class="large-text">' + message.content + '</span></p>';
            messageElement += '<p><i class="fas fa-tags"></i><strong></strong>' + getTagsAsLinks(message.tags) + '</p>';
            messageElement += '<p><i class="fas fa-image"></i><strong></strong></p>';
            messageElement += '<ul>';
            Object.keys(message).filter(key => key.startsWith('imageUrl_')).forEach(key => {
                messageElement += '<li><img src="' + message[key] + '" style="width: 200px; height: 200px;"></li>';
            });
            messageElement += '</ul>';

            const commentContainerId = 'comments-' + doc.id;
            messageElement += '<div id="' + commentContainerId + '"></div>';
            const commentForm = '<form class="commentForm" data-message-id="' + doc.id + '">' +
                '<div style="display: flex; align-items: center;">' +
                '<input type="text" name="commentContent" placeholder="請输入評論内容" style="width: 1600px; margin-right: 10px; border: 2px solid #ccc; border-radius: 5px; padding: 5px;">' +
                '<button type="submit" class="submitCommentButton">提交評論</button>' +
                '</div>' +
                '</form>';

            messagesContainer.innerHTML += messageElement + commentForm;
            messagesContainer.insertAdjacentHTML('beforeend', '<hr>');

            globalMessageInfo[doc.id] = { userId: message.userId, title: message.title };

            const commentForms = document.querySelectorAll('.commentForm');
            commentForms.forEach(commentForm => {
                commentForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const commentContent = commentForm.querySelector('input[name="commentContent"]').value;
                    const messageId = commentForm.getAttribute('data-message-id');
                    const messageInfo = globalMessageInfo[messageId];

                    if (messageInfo) {
                        handleCommentSubmit(event, messageInfo, userId, db, commentContent);
                    } else {
                        console.error('Failed to find message info.');
                    }
                });
            });

            displayComments(doc.id, commentContainerId);
        }

        const tagsLinks = document.querySelectorAll('.tag-link');
        tagsLinks.forEach(tagLink => {
            tagLink.addEventListener('click', function (event) {
                event.preventDefault();
                const tag = tagLink.textContent.trim();
                filterMessagesByTag(tag);
            });
        });

    } catch (error) {
        console.error('Error fetching messages:', error);
    }
}



// 将标签数组转换为超链接列表
function getTagsAsLinks(tagsArray) {
    if (!Array.isArray(tagsArray)) {
        return '';
    }

    let tagsHTML = '';
    tagsArray.forEach(tag => {
        tagsHTML += '<a href="#" class="tag-link">' + tag + '</a> ';
    });
    return tagsHTML;
}

// 根据标签过滤留言并重新显示
async function filterMessagesByTag(tag) {
    try {
        const querySnapshot = await db.collection('project').doc('messages').collection('messages').where('tags', 'array-contains', tag).get();
        console.log('Messages filtered by tag:', tag, 'Total:', querySnapshot.docs.length);

        // 清空之前显示的留言
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';

        // 遍历每条留言并渲染到 HTML 页面上
        querySnapshot.forEach((doc, index) => {
            console.log('Rendering message:', doc.id);
            const message = doc.data(); // 获取留言数据

            // 将时间转换为格式化的字符串
            const formattedTime = message.time.toDate().toLocaleString(); // 将时间转换为本地时间格式的字符串

            // 构建留言的 HTML 元素
            let messageElement = '<div class="message">';
            <!-- messageElement += '<p><h4><strong>標題:</strong> ' + message.title + '</h4></p>'; -->
			
			// 构建标题和按钮容器
			const titleAndButtonsContainer = document.createElement('div');
			titleAndButtonsContainer.style.display = 'flex'; // 设置容器为弹性布局
			titleAndButtonsContainer.style.alignItems = 'center'; // 垂直居中对齐

			// 添加标题
			const titleElement = document.createElement('h4');
			titleElement.innerHTML = '<strong>標題:</strong> ' + message.title;
			titleElement.style.width = '2000px'; // 设置标题的宽度
			titleAndButtonsContainer.appendChild(titleElement);
			
            // 添加修改和删除按钮（如果用户ID匹配）
            if (message.userId === userId) {
                <!-- // 构建修改按钮 -->
                <!-- const editButton = document.createElement('button'); -->
                <!-- editButton.textContent = '修改'; // 设置按钮的文本内容 -->
				<!-- editButton.style.backgroundColor = 'green'; // 设置修改按钮的背景颜色 -->

                <!-- messageElement += editButton.outerHTML; -->

                <!-- // 构建删除按钮 -->
                <!-- const deleteButton = document.createElement('button'); -->
                <!-- deleteButton.textContent = '刪除'; // 设置按钮的文本内容 -->
				<!-- deleteButton.style.backgroundColor = 'red'; // 设置删除按钮的背景颜色 -->

                <!-- messageElement += deleteButton.outerHTML; -->
				
				// 添加修改按钮
				const editButton = document.createElement('button');
				editButton.textContent = '修改'; // 设置按钮的文本内容
				editButton.style.backgroundColor = 'green'; // 设置修改按钮的背景颜色
				editButton.style.marginLeft = 'auto'; // 将修改按钮靠右对齐
				titleAndButtonsContainer.appendChild(editButton);

				// 添加删除按钮
				const deleteButton = document.createElement('button');
				deleteButton.textContent = '刪除'; // 设置按钮的文本内容
				deleteButton.style.backgroundColor = 'red'; // 设置删除按钮的背景颜色
				deleteButton.style.marginLeft = '10px'; // 设置删除按钮与修改按钮之间的间距
				titleAndButtonsContainer.appendChild(deleteButton);
            }
			// 将标题和按钮容器添加到消息元素中
			messageElement += '<p>';
			messageElement += titleAndButtonsContainer.outerHTML;
			messageElement += '</p>';
            messageElement += '<p><strong>名稱:</strong> ' + message.userId + '</p>';
            messageElement += '<p><strong>時間:</strong> ' + formattedTime + '</p>';
            messageElement += '<p><strong>內文:</strong> ' + message.content + '</p>';
            messageElement += '<p><strong>標籤:</strong> ' + getTagsAsLinks(message.tags) + '</p>';
            messageElement += '<p><strong>圖片:</strong></p>';
            messageElement += '<ul>';
            Object.keys(message).filter(key => key.startsWith('imageUrl_')).forEach(key => {
                messageElement += '<li><img src="' + message[key] + '" style="width: 200px; height: 200px;"></li>';
            });
            messageElement += '</ul>';

            // 添加修改和删除按钮（如果用户ID匹配）
            //if (message.userId === userId) {
                // 构建修改按钮
               // const editButton = document.createElement('button');
                //editButton.textContent = '修改'; // 设置按钮的文本内容

                //messageElement += editButton.outerHTML;

                // 构建删除按钮
               // const deleteButton = document.createElement('button');
               // deleteButton.textContent = '刪除'; // 设置按钮的文本内容

               // messageElement += deleteButton.outerHTML;
           // }

            // 创建评论容器和评论表单
            const commentContainerId = 'comments-' + doc.id;
            messageElement += '<div id="' + commentContainerId + '"></div>'; // 创建评论容器
             const commentForm = '<form class="commentForm" data-message-id="' + doc.id + '">' +
                        '<div style="display: flex; align-items: center;">' +
                            '<input type="text" name="commentContent" placeholder="請输入評論内容" style="width: 1600px; margin-right: 10px; border: 2px solid #ccc; border-radius: 5px; padding: 5px;">' +
                            '<button type="submit" class="submitCommentButton">提交評論</button>' +
                        '</div>' +
                    '</form>';

            // 将留言元素和评论表单添加到页面上
            messagesContainer.innerHTML += messageElement + commentForm;
            // 添加分隔线
            messagesContainer.insertAdjacentHTML('beforeend', '<hr>');

            // 将留言的相关信息存储到全局变量中
            globalMessageInfo[doc.id] = {userId: message.userId, title: message.title};

            // 添加事件监听器以便在留言表单提交时重新加载留言和评论
            const commentForms = document.querySelectorAll('.commentForm');
            commentForms.forEach(commentForm => {
                commentForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const commentContent = commentForm.querySelector('input[name="commentContent"]').value;
                    const messageId = commentForm.getAttribute('data-message-id');
                    const messageInfo = globalMessageInfo[messageId];

                    // 检查留言信息是否存在
                    if (messageInfo) {
                        // 调用处理评论提交的函数，并传递留言的相关信息和评论内容
                        handleCommentSubmit(event, messageInfo, userId, db, commentContent);
                    } else {
                        console.error('Failed to find message info.');
                    }
                });
            });
			
			displayComments(doc.id, commentContainerId); // 根据留言的ID显示评论，传入评论容器的ID
        });

        // 添加标签点击事件监听器
        const tagsLinks = document.querySelectorAll('.tag-link');
        tagsLinks.forEach(tagLink => {
            tagLink.addEventListener('click', function(event) {
                event.preventDefault();
                const tag = tagLink.textContent.trim();
                filterMessagesByTag(tag);
            });
        });
    } catch (error) {
        console.error('Error filtering messages by tag:', error);
    }
}





async function displayComments(messageId, commentContainerId) {
    try {
        const querySnapshot = await db.collection('project').doc('messages').collection('reply').where('messageId', '==', messageId).get();
        console.log('Comments fetched successfully for message:', messageId, 'Total:', querySnapshot.docs.length);

        const commentsContainer = document.getElementById(commentContainerId);
        if (!commentsContainer) {
            console.error('Comments container not found:', commentContainerId);
            return;
        }

        commentsContainer.innerHTML = ''; // 清空之前显示的评论

        // 获取所有用户的 ID
        const userIds = querySnapshot.docs.map(doc => doc.data().userId);

        // 获取所有用户的信息
        const userProfiles = await Promise.all(userIds.map(userId => fetchUserProfile(userId)));

        // 创建一个用户信息的映射
        const userProfileMap = {};
        userIds.forEach((userId, index) => {
            userProfileMap[userId] = userProfiles[index];
        });

        console.log('User profile map:', userProfileMap);

        // 遍历每条评论
        for (const doc of querySnapshot.docs) {
            const commentData = doc.data();
            const formattedTime = commentData.time.toDate().toLocaleString();

            // 获取用户信息
            const userProfile = userProfileMap[commentData.userId] || {};
            const { pictureUrl = '', displayName = '' } = userProfile;
            const userInfoHtml = '<p><img src="' + pictureUrl + '" alt="User Avatar" class="avatar" /> <strong>' + displayName + '</strong> (' + commentData.userId + ')</p>';

            let commentElement = '<div class="comment" style="border: 1px solid #ccc; background-color: #f5f5f5; margin-bottom: 10px; padding: 10px;" data-comment-id="' + doc.id + '">';
            commentElement += userInfoHtml; // 插入用户信息
            commentElement += '<p><strong>时间:</strong> ' + formattedTime + '</p>';
            commentElement += '<p><strong>内容:</strong> ' + commentData.content + '</p>';

            // 添加修改和删除按钮（如果评论是当前用户发布的）
            if (commentData.userId === userId) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.style.display = 'flex'; // 设置容器为弹性布局
                buttonsContainer.style.alignItems = 'center'; // 垂直居中对齐

                // 构建修改按钮
                const editcommentButton = document.createElement('button');
                const icon3 = document.createElement('i');
                icon3.className = 'fas fa-edit'; // Font Awesome 图标类
                icon3.style.marginRight = '8px'; // 设置图标右边距
                const textNode3 = document.createTextNode('修改评论');
                editcommentButton.appendChild(icon3);
                editcommentButton.appendChild(textNode3);
                editcommentButton.style.backgroundColor = '#007bff'; // 设置修改按钮的背景颜色
                buttonsContainer.appendChild(editcommentButton);

                // 构建删除按钮
                const deletecommentButton = document.createElement('button');
                const icon4 = document.createElement('i');
                icon4.className = 'fas fa-trash'; // Font Awesome 图标类
                icon4.style.marginRight = '8px'; // 设置图标右边距
                const textNode4 = document.createTextNode('删除评论');
                deletecommentButton.appendChild(icon4);
                deletecommentButton.appendChild(textNode4);
                deletecommentButton.style.backgroundColor = 'red'; // 设置删除按钮的背景颜色
                deletecommentButton.style.marginLeft = '10px'; // 设置删除按钮与修改按钮之间的间距
                buttonsContainer.appendChild(deletecommentButton);

                // 添加空白的 div 元素来创建间距
                const spacer = document.createElement('div');
                spacer.style.height = '80px'; // 设置空白元素的高度
                buttonsContainer.appendChild(spacer);

                // 将按钮容器添加到评论元素中
                commentElement += buttonsContainer.outerHTML;
            }

            commentElement += '</div>';

            // 使用 DOM 操作添加评论内容
            commentsContainer.insertAdjacentHTML('beforeend', commentElement);
        }
    } catch (error) {
        console.error('Error fetching comments:', error);
    }
}


    




async function handleCommentSubmit(event, messageInfo, userId, db, commentContent) {
    console.log('handleCommentSubmit function is called.');
    
    event.preventDefault(); // 阻止表单默认提交行为

    try {
        // 将评论内容存储到数据库中
        const docName = messageInfo.userId + '_' + messageInfo.title + '_' + generateRandomId();
        console.log(docName);
        const replyRef = db.collection('project').doc('messages').collection('reply').doc(docName);

        // 更新评论内容
        await replyRef.set({
            userId: userId, // 评论的用户ID
            messageId: messageInfo.userId + '_' + messageInfo.title, // 关联的留言ID
            content: commentContent, // 评论内容
            time: firebase.firestore.FieldValue.serverTimestamp() // 当前时间戳
        });

        console.log('Comment added successfully!');
		alert('評論新增成功');
		// 添加评论成功后重新加载留言和评论
        displayMessages(); // 重新加载留言和评论
    } catch (error) {
        console.error('Error adding comment:', error);
    }
}





		
		
		



function editMessage(userId, replyNumber) {
    // 获取留言内容
    const db = firebase.firestore();
    const docName = userId + '_' + replyNumber;
    const messageRef = db.collection('project').doc('messages').collection('messages').doc(docName);

    // 获取表单元素
    const form = document.getElementById('editForm');

    // 显示对话框
    const editDialog = document.getElementById('editDialog');
    editDialog.style.display = 'block'; // 显示对话框

    // 获取留言数据
    messageRef.get().then(doc => {
        if (doc.exists) {
            const messageData = doc.data();

            // 将留言内容填充到表单字段中
            form.elements['content'].value = messageData.content;
            form.elements['tags'].value = messageData.tags.join(' '); // 将标签数组以空格分隔显示在表单中

            // 创建或更新图片链接字段
            Object.keys(messageData).forEach(key => {
                if (key.startsWith('imageUrl_')) {
                    const index = key.split('_')[1];
                    const imageUrlLink = document.getElementById('imageUrl_' + index + '_link');
                    if (!imageUrlLink) {
                        // 如果链接字段不存在，则创建一个
                        const newLink = document.createElement('a');
                        newLink.id = 'imageUrl_' + index + '_link';
                        newLink.href = messageData[key];
                        newLink.textContent = messageData[key];
                        const imageContainer = document.getElementById('imageContainer');
                        imageContainer.appendChild(newLink);
                    } else {
                        // 如果链接字段已存在，则更新链接
                        imageUrlLink.href = messageData[key];
                        imageUrlLink.textContent = messageData[key];
                    }
                }
            });
        } else {
            console.error('留言文檔不存在');
            alert('留言文檔不存在');
        }
    }).catch(error => {
        console.error('獲取留言資料時發生錯誤：', error);
        alert('獲取留言資料時發生錯誤：' + error.message);
    });

form.addEventListener('submit', event => {
    event.preventDefault();

    // 获取表单数据
    const formData = new FormData(form);
    const content = formData.get('content');
    //const tags = formData.get('tags').split('#').map(tag => tag.trim()).filter(tag => tag !== ''); 
	let tags = formData.get('tags').split('#').map(tag => tag.trim()).filter(tag => tag !== ''); // 将标签以#分隔为数组

     // 添加#到每个标签
     tags = tags.map(tag => '#' + tag);
		
    // 检查是否有选择了新图片
	const imageFiles = formData.getAll('image'); // 获取所有上传的图片文件
	if (imageFiles.some(file => new RegExp('^image/').test(file.type))) {
		// 至少有一个文件是图像类型
		uploadImageToServer(userId, replyNumber, imageFiles, true)
			.then(() => {
				// 图片上传完成后，更新留言内容和标签
				updateMessageContentAndTagsnewimage(messageRef, content, tags, editDialog);
			})
			.catch(error => {
				console.error('上傳圖片時發生錯誤：', error);
				alert('上傳圖片時發生錯誤：' + error.message);
			});
	} else {
		// 没有选择新图片，直接更新留言内容和标签
		const imageUrls = {};
		Object.keys(formData).forEach(key => {
			if (key.startsWith('imageUrl_')) {
				imageUrls[key] = formData[key];
			}
		});
		updateMessageContentAndTags(messageRef, content, tags, editDialog, imageUrls);
	}



});
}







function updateMessageContentAndTags(messageRef, content, tags, editDialog, imageUrls) {
    // 更新留言内容、标签和图片链接
    const updateData = {
        content: content,
        tags: tags
    };

    // 添加图片链接到更新数据中
    Object.keys(imageUrls).forEach(key => {
        updateData[key] = imageUrls[key];
    });

    messageRef.update(updateData)
        .then(() => {
            console.log('留言已成功更新');
            alert("留言已成功更新！");
            editDialog.style.display = 'none'; // 更新成功后隐藏对话框
        })
        .catch(error => {
            console.error('更新留言時發生錯誤：', error);
            alert('更新留言時發生錯誤：' + error.message);
        });
}


function updateMessageContentAndTagsnewimage(messageRef, content, tags, editDialog) {
    // 更新留言内容、标签和图片链接
    const updateData = {
        content: content,
        tags: tags
    };

    

    messageRef.update(updateData)
        .then(() => {
            console.log('留言已成功更新');
            alert("留言已成功更新！");
            editDialog.style.display = 'none'; // 更新成功后隐藏对话框
        })
        .catch(error => {
            console.error('更新留言時發生錯誤：', error);
            alert('更新留言時發生錯誤：' + error.message);
        });
}



		let uploadStarted = false;
		let uploadFinished = false;

		async function uploadImageToServer(userId, replyNumber, imageFiles, deleteExistingImages = false) {
			try {
				const db = firebase.firestore();
				const docName = userId + '_' + replyNumber;
				const messageRef = db.collection('project').doc('messages').collection('messages').doc(docName);

				// 删除数据库中原有的所有图片链接（如果需要）
				if (deleteExistingImages) {
					const deletePromises = [];
					const messageData = await messageRef.get().then(doc => doc.data());
					for (let i = 0; i < Object.keys(messageData).length; i++) {
						const imageUrlKey = 'imageUrl_' + i;
						deletePromises.push(messageRef.update({
							[imageUrlKey]: firebase.firestore.FieldValue.delete() // 使用 delete 方法删除字段
						}));
					}
					// 等待所有删除操作完成
					await Promise.all(deletePromises);
					console.log('資料庫中原有的圖片連結已成功刪除');
				}


				// 上传所有新图片到服务器
				const uploadPromises = imageFiles.map(async (imageFile, index) => {
					try {
						// 创建存储引用
						const storageRef = firebase.storage().ref();

						// 生成唯一的文件名
						const fileName = `${Date.now()}_${imageFile.name}`;

						// 构建存储路径，将文件上传到 `images` 文件夹下
						const imagePath = `images/${fileName}`;

						// 上传文件到 Firebase Storage
						const uploadTask = storageRef.child(imagePath).put(imageFile);
						
						
						 // 添加上传任务状态变化监听器
						uploadTask.on('state_changed', 
							snapshot => {
								// 上传开始
								if (!uploadStarted) {
									console.log('Upload started');
									uploadStarted = true;
								}
								
								// 上传进度
								const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
								console.log('Upload is ' + progress + '% done');

								// 上传完成
								if (progress === 100 && !uploadFinished) {
									console.log('Upload finished');
									uploadFinished = true;
									// 在这里添加上传完成后的逻辑处理
								}
							},
							error => {
								// 上传过程中出错
								console.error('Error uploading image to Firebase Storage:', error);
								reject(error);
							}
						);

						// 返回一个 Promise，等待上传完成
						return new Promise((resolve, reject) => {
							// 监听上传任务状态变化
							uploadTask.on('state_changed', 
								snapshot => {
									// 上传进度
									const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
									console.log('Upload is ' + progress + '% done');
								},
								error => {
									// 上传过程中出错
									console.error('Error uploading image to Firebase Storage:', error);
									reject(error);
								},
								async () => {
									// 上传完成
									console.log('Image uploaded successfully');

									try {
										// 获取上传文件的下载 URL
										const imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
										console.log('Image URL:', imageUrl);

										// 在上传完成后更新留言数据
										const updateData = {
											['imageUrl_' + index]: imageUrl
										};

										messageRef.update(updateData).then(() => {
											console.log(`圖片 URL ${index} 已成功更新`);
											resolve();
										}).catch(error => {
											console.error(`更新圖片 URL ${index} 時發生錯誤：`, error);
											reject(error);
										});
									} catch (error) {
										console.error('Error getting download URL:', error);
										reject(error);
									}
								}
							);
						});
					} catch (error) {
						console.error('Error uploading image to Firebase Storage:', error);
						throw error;
					}
				});

				// 等待所有图片上传完成
				await Promise.all(uploadPromises);
				console.log('所有圖片上傳完成');
			} catch (error) {
				console.error('Error uploading images to Firebase Storage:', error);
				throw error;
			}
		}


		async function editComment(commentId) {
			try {
				const newContent = prompt('請輸入修改後的評論内容：');
				if (newContent === null) {
					// 用户取消了输入
					return;
				}

				// 更新评论内容和时间戳
				await db.collection('project').doc('messages').collection('reply').doc(commentId).update({
					content: newContent,
					time: firebase.firestore.FieldValue.serverTimestamp() // 更新时间戳
				});

				console.log('Comment updated successfully:', commentId);
				alert("評論已成功更新！");
				// 在这里执行任何其他必要的操作
				displayMessages(); // 重新加载留言和评论
				
			} catch (error) {
				console.error('Error updating comment:', error);
			}
		}









		function deleteMessage(userId, replyNumber) {
		console.log(userId);
		console.log(replyNumber);
			const confirmDelete = confirm("確定要刪除這篇留言嗎？");
			if (confirmDelete) {
				// 构建文档名称，使用 userId_title 形式
				const docName = userId + '_' + replyNumber;

				// 在 Firestore 中删除文档
				firebase.firestore().collection('project').doc('messages').collection('messages').doc(docName).delete()
					.then(() => {
						console.log('留言已成功删除');
						alert("留言已成功删除！");
					})
					.catch((error) => {
						console.error('刪除留言時發生錯誤：', error);
					});
			}
		}
		
		async function deleteComment(commentId) {
		const confirmDelete = confirm("確定要刪除這篇評論嗎？");
		try {
			await db.collection('project').doc('messages').collection('reply').doc(commentId).delete();
			console.log('Comment deleted successfully:', commentId);
			alert("評論已成功删除！");
			// 在这里执行任何其他必要的操作
			displayMessages(); // 重新加载留言和评论
		} catch (error) {
			console.error('Error deleting comment:', error);
		}
		}
		
		





//displayMessages(); // 页面加载完成后显示留言
		
 });



	
        
        
    </script>
    
    <style>
       div{ word-wrap:break-word; word-break:normal;}
       
       
       .container {
			border: 2px solid #ccc; /* 设置边框样式 */
			border-radius: 10px; /* 设置边框圆角 */
			max-width: 600px;
			width: 90%; /* 设置宽度为父元素宽度的100% */
			margin: 0 auto;
			padding: 20px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}


        h1 {
            text-align: center;
        }

        form {
            margin-bottom: 20px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #6a4432;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        #messages {
            margin-top: 20px;
        }

        .message {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
		
		/* 在 CSS 中設置彈出式視窗的樣式 */
		.modal {
			display: none; /* 隱藏彈出式視窗 */
			position: fixed;
			z-index: 1;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.9); /* 黑色背景，透明度 0.9 */
		}

		.modal-content {
			margin: auto;
			display: block;
			height: 70%;
			width: 80%;
			max-width: none; /* 移除最大宽度限制 */
			max-height: none; /* 移除最大高度限制 */
		}
			/* 模态对话框样式 */
		.modal-content input[type="text"],
		.modal-content textarea {
			color: white; /* 设置文本颜色为白色 */
			/* 添加其他样式，例如背景色、边框等 */
		}

		.close {
			position: absolute;
			top: 15px;
			right: 35px;
			color: #f1f1f1;
			font-size: 40px;
			font-weight: bold;
			transition: 0.3s;
		}

		.close:hover,
		.close:focus {
			color: #bbb;
			text-decoration: none;
			cursor: pointer;
		}
		/* 默认状态下的按钮样式 */
		.small-button {
			width: 80px; /* 設置按鈕的寬度為 80 像素 */
			height: 30px; /* 設置按鈕的高度為 30 像素 */
			font-size: 14px; /* 設置按鈕文字的字體大小 */
			background-color: #007bff; /* 蓝色 */
			color: #fff; /* 白色 */
			border: none;
			padding: 5px 10px;
			cursor: pointer;
			border-radius: 5px;
		}

		/* 被选择状态下的按钮样式 */
		.selected-button {
			background-color: #6c757d; /* 灰色 */
		}
		
		#selectImageButton {
        background-color: green;
        /* 添加其他样式，如边框、颜色、字体等 */
		border-radius: 10px; /* 通过设置合适的像素值来调整圆角的大小 */
		}
		
		#modifyImageButton {
        background-color: green;
        /* 添加其他样式，如边框、颜色、字体等 */
		border-radius: 10px; /* 通过设置合适的像素值来调整圆角的大小 */
		}
		
		#submitButton {
		border-radius: 10px; /* 通过设置合适的像素值来调整圆角的大小 */
		
		}
		#showAllMessagesButton{
			background-color: #8d6955;
		}
		
		
		#confirmButton {
		border-radius: 10px; /* 通过设置合适的像素值来调整圆角的大小 */
		}
		/* 样式表中添加以下样式 */
		.fixed-size-image {
			width: 200px; /* 设置图片宽度为200像素 */
			height: 200px; /* 设置图片高度为200像素 */
			object-fit: cover; /* 让图片保持原始比例，但填满整个元素，可能会裁剪部分图片 */
		}
		 /* 样式化对话框 */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .dialog-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
		
		#imageContainer {
			max-width: 300px; /* 设置容器的最大宽度 */
			max-height: 300px; /* 设置容器的最大高度 */
			overflow: auto; /* 添加滚动条，以便在容器溢出时滚动查看 */
		}


		#imageContainer img {
			max-width: 100%;
			max-height: 100%;
		}
		
		 .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }

        .dialog-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
        }
		
		.button-container {
			display: flex;
		}

		.button-container button {
			margin-right: 10px; /* 设置按钮之间的间距 */
		}
		
		.full-width-image {
			width: 95%;
				height: auto;
				max-height: 550px; /* 设置图片的最大高度 */
				display: block;
				margin: 0;
				padding-left: 80px;
				padding-top: 100px;
				object-fit: cover; /* 确保图片在缩放时保持其宽高比 */
				position: relative; /* 确保图片在父容器内定位 */
				z-index: 1; /* 设置z-index以确保其在最下面 */
				margin-bottom: 50px;
		}

		.full-width-image-title {
			width: 20%; /* 确保图片宽度适应屏幕宽度 */
			max-height: 100px;
			height: auto;
			display: block;
			margin: 0 auto; /* 水平居中对齐 */
			object-fit: cover;
			position: fixed;
			top: 25px;
			left: 0;
			right: 0;
			background-color: #fff;
			transition: transform 0.3s ease; /* 平滑过渡 */
			z-index: 3;
		}
		.fixed-background {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100px; /* 固定的高度 */
			background-color: #fff; /* 背景颜色 */
			box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); /* 可选阴影效果 */
			z-index: 3;
		}

		.shadow-line {
			position: fixed;
			top: 100px;
			left: 0;
			width: 100%;
			height: 1px;
			box-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
			background-color: #fff;
			z-index: 3;
		}
		
		 .input-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-container i {
            background-color: #4a2b1e;
            color: white;
            padding: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
		.input-container label {
            font-size: 1em; /* 增加字体大小 */
            color: #333; /* 改变文本颜色 */
            margin-right: 10px;
        }
        .input-container input,
        .input-container textarea {
            flex: 1;
            padding: 10px;
            font-size: 1em; /* 设置输入框字体大小 */
        }
		
		p i {
			background-color: #4a2b1e;
			color: white;
			padding: 5px;
			border-radius: 50%;
			margin-right: 10px;
		}
		.large-text {
			font-size: 1.5em; /* 这里可以根据需要调整字体大小 */
		}
		
		 .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        .user-info {
            display: flex;
            align-items: center;
        }







		


    </style>
    
</head>
<body>
	<div class="fixed-background"></div> <!-- 固定白色背景区域 -->
    <img src="https://imgur.com/Z9EYazU.png" alt="Full Width Image" class="full-width-image-title">
	<div class="shadow-line"></div> <!-- 阴影线 -->
    <img src="https://imgur.com/fVH42uz.png" alt="Full Width Image" class="full-width-image">
	
	
	
	
	

	
  <div class="row">
    <div class="container">
        <h1>新增留言板</h1>
		<div class="row">
		<form id="messageForm">
			<div class="input-container">
				<i class="fas fa-heading"></i>
				<label for="titleInput">標題：</label>
				<input type="text" id="titleInput" name="titleInput"><br><br>
			 </div>
			
			
			 <div class="input-container">
				<i class="fas fa-align-left"></i>
				<label for="contentInput">内容：</label>
				<textarea id="contentInput" name="contentInput"></textarea><br><br>
			</div>
			<!--<label for="dateInput">日期:</label>
			<input type="date" id="dateInput" name="dateInput"><br><br>-->
			
			
			<div class="input-container">
				<i class="fas fa-image"></i>
				<label for="imageInput">上傳圖片：</label>
				<input type="file" id="imageInput" name="imageInput"  multiple><br><br>
			</div>
			<div id="uploadedImagesContainer">
				<!-- 这里是上传的图片显示的区域，初始时可能为空 -->
			</div>

			<div class="input-container">
				<i class="fas fa-tags"></i>
				<label for="tagsInput">Tags(請以#開頭輸入)：</label>
				<input type="text" id="tagsInput" name="tagsInput">
			</div>
			<ul id="tagsList" style="display: none;">
				<li>永續</li>
				<li>環保</li>
				<li>環保材質</li>
				<li>短褲</li>
				<li>長褲</li>
				<li>牛仔褲</li>
				<li>寬褲</li>
				<li>T恤</li>
				<li>大學T</li>
				<li>帽T</li>
				<li>洋裝</li>
				<li>帽子</li>
			</ul><br>

			
			<!-- <input type="submit" id="submitButton" value="提交"> -->
			<button type="submit" id="submitButton">提交</button>
		</form>

        </div>
    </div>
	
	<div class="container">
        <h1>留言板</h1>
		<button type="submit" id="showAllMessagesButton">顯示全部留言</button>

		<div id="messages"></div>
		<div class="row"></div> <!-- 插入空白的 div 元素 -->
		<form id="commentForm"> 		
		</form>
	</div>
	
	 <!-- 定义对话框容器 -->
	 
	   <div id="editDialog" class="dialog-overlay">
    <div class="dialog-content">
        <h2>編輯留言</h2>
        <form id="editForm">
            <label for="content">内容：</label><br>
            <textarea id="content" name="content"></textarea><br>
            <label for="tags">標籤：</label><br>
            <input type="text" id="tags" name="tags"><br>
            <label for="image">選擇要重新上傳的圖片：</label><br>
            <input type="file" id="image" name="image" multiple><br>
            <!-- 图片容器 -->
            <div id="imageContainer"></div> <!-- 这里将用来显示图片链接 -->
            <div style="display: flex; justify-content: space-between;">
				<button type="submit" style="background-color: green;">保存修改</button>
				<div style="width: 20px;"></div> <!-- 添加空的 div 元素 -->
				<button type="button" id="closeDialogButton" style="background-color: red;">關閉</button>
			</div>

        </form>
    </div>
</div>


	
<script>
    // 等待文档加载完成
    document.addEventListener("DOMContentLoaded", function() {
        // 获取对话框和关闭按钮的引用
        const editDialog = document.getElementById('editDialog');
        const closeDialogButton = document.getElementById('closeDialogButton');

        // 检查元素是否存在
        if (editDialog && closeDialogButton) {
            // 添加事件监听器，当点击关闭按钮时关闭对话框
            closeDialogButton.addEventListener('click', function() {
                closeEditDialog();
            });

            // 添加事件监听器，当点击对话框外部时关闭对话框
            editDialog.addEventListener('click', function(event) {
                // 检查点击的是不是对话框外部
                if (event.target === editDialog) {
                    closeEditDialog();
                }
            });
        } else {
            console.error('editDialog 或 closeDialogButton 为 null');
        }

        // 定义关闭对话框的函数
        function closeEditDialog() {
            editDialog.style.display = 'none';
        }
		
		
		
		
    });
</script>
    <script>
        const userId = 'U0a49e765a241d21992c6d0a8f5fa4a34'; // 替????的 LINE 用? ID

	   // const apiUrl = process.env.NEXT_PUBLIC_API_BASE_URL;

	const apiUrl = 'https://my-project-chenyihsiu.vercel.app';

        async function fetchUserProfile(userId) {
            try {
                const response = await fetch(apiUrl + '/api/user-profile/' + encodeURIComponent(userId));
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }

        async function updateUserInfo(userId) {
            const userInfoElement = document.getElementById('user-info');
            const userProfile = await fetchUserProfile(userId);
            let content = '';
            if (userProfile) {
                const { pictureUrl, displayName } = userProfile;
                content = '<img src="' + pictureUrl + '" alt="User Avatar" class="avatar" /> ' +
                          '<strong>' + displayName + ' (' + userId + ')</strong>';
            } else {
                content = '<strong>Error fetching user info</strong>';
            }
            userInfoElement.innerHTML = content;
        }

        updateUserInfo(userId);
    </script>

    <hr />  
    <div>LINE版本: <span id="getLineVersion"></span></div>
    <div>內建瀏覽: <span id="isInClient"></span></div>
    <div>LIFF尺寸: <span id="getContextViewType"></span></div>
    <div>來自何處: <span id="getContextType"></span></div>
    <div>1對1聊天: <span id="getContextUtouId"></span></div>
    <div>群組序號: <span id="getContextGroupId"></span></div>
    <div>聊天室號: <span id="getContextRoomId"></span></div>
    <div>登入與否: <span id="isLoggedIn"></span></div>
    <hr />
    <div>使用名稱: <span id="getProfileDisplayName"></span></div>
    <div>使用序號: <span id="getProfileUserId"></span></div>
    <div>頭像圖檔: <span id="getProfilePictureUrl"></span></div>
    <hr />
    <div>作業系統: <span id="getOS"></span></div>
    <div>使用語言: <span id="getLanguage"></span></div>
    <hr />

</body>
</html>
